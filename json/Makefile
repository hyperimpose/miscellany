ROOT_DIR := $(realpath $(dir $(realpath $(lastword $(MAKEFILE_LIST)))))

# The project directories are according to the OTP principles
EBIN := ${ROOT_DIR}/ebin
SRC  := ${ROOT_DIR}/src
INCLUDE := ${ROOT_DIR}/include

# OTP Application - Rememeber to bump the version for new releases
APP_NAME := $(notdir $(ROOT_DIR))
APP_VER := 0.0.1

APP_SPEC_SRC := $(SRC)/$(APP_NAME).app.src
APP_SPEC := $(EBIN)/$(APP_NAME).app

# Source code
ERL_FILES := $(shell find $(SRC) -name '*.erl')
BEAM_FILES := $(patsubst %.erl,$(EBIN)/%.beam,$(notdir $(ERL_FILES)))

HRL_DIRS := $(shell find ${SRC} -name '*.hrl')
HRL_DIRS := $(if $(strip $(HRL_DIRS)),\
                 $(shell echo ${HRL_DIRS} | xargs dirname | sort -u),)
ifneq ($(wildcard $(INCLUDE)/*),)
    HRL_DIRS += $(shell find ${INCLUDE} -name '*.hrl' | xargs dirname | sort -u)
endif

# Erlang Compiler
ERLC := erlc

INCLUDE_FLAG := $(addprefix -I ,$(HRL_DIRS))
ERLCFLAGS = $(INCLUDE_FLAG) -MMD -MP


.PHONY: all clean


all: $(APP_SPEC) $(BEAM_FILES)


${BEAM_FILES}: ${ERL_FILES} | $(EBIN)
	$(ERLC) $(ERLCFLAGS) -o $(EBIN) -- $?


${APP_SPEC}: ${APP_SPEC_SRC} | $(EBIN)
	sed 's/=version=/${APP_VER}/g' ${APP_SPEC_SRC} > ${APP_SPEC}


$(EBIN):
	mkdir -p $@


clean:
	rm -rf $(EBIN)



# These are generated by the compiler from the MMD and MP options
-include $(BEAM_FILES:.beam=.Pbeam)
